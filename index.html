<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ã©ã‚“ãªãã‚‚ã¡ï¼Ÿ</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#667085; --card:#f7f7f9; --border:#e5e7eb;
      --acc:#2563eb; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.08);
      --ok:#16a34a; --calm:#60a5fa; --angry:#ef4444; --sad:#60a5fa; --fear:#8b5cf6; --shy:#f59e0b; --sleep:#94a3b8; --fun:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"BIZ UDPGothic","Noto Sans JP",sans-serif;color:var(--fg);background:var(--bg);line-height:1.6}
    header,footer{padding:16px}
    header{border-bottom:1px solid var(--border)}
    .container{max-width:960px;margin:auto;padding:12px}

    /* Grid of emotion buttons */
    .grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    @media (max-width:780px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:520px){ .grid{grid-template-columns:repeat(2,1fr)} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}

    .emobtn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
      padding:16px;border-radius:20px;border:1px solid var(--border);background:#fff;cursor:pointer;
      min-height:120px; text-align:center; transition:transform .05s ease-in-out, box-shadow .15s;
      user-select:none; -webkit-tap-highlight-color:transparent;
    }
    .emobtn:active{transform:scale(.98)}
    .emobtn .emoji{font-size:40px;line-height:1}
    .emobtn .label{font-size:18px}

    /* Controls */
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 4px}
    .switch{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .switch input{appearance:none;width:22px;height:22px;border:1px solid var(--border);border-radius:6px;display:inline-block;vertical-align:middle;margin:0;position:relative}
    .switch input:checked{background:var(--acc);border-color:var(--acc)}
    .switch input:checked::after{content:"";position:absolute;inset:5px;background:#fff;border-radius:2px}

    .range{display:flex;align-items:center;gap:8px}
    .range input[type="range"]{accent-color:var(--acc)}

    .add-btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .add-btn.primary{background:var(--acc);color:#fff;border-color:transparent}

    /* Overlay / Dialogs */
    .overlay{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .overlay[aria-hidden="false"]{display:flex}

    /* Big panel */
    .panel{width:min(900px,96vw);height:min(700px,90vh);background:#fff;border-radius:24px;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
    .panel-title{margin:0;font-size:18px}
    .panel-body{flex:1;display:grid;place-items:center;padding:12px}
    .big{display:flex;flex-direction:column;align-items:center;gap:10px}
    .big .emoji{font-size:min(30vh,220px)}
    .big .text{font-size:min(8vh,64px)}
    .panel-footer{display:flex;justify-content:center;gap:10px;padding:12px;border-top:1px solid var(--border)}
    .btn{padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;font-size:16px}
    .btn.primary{background:var(--acc);color:#fff;border-color:transparent}

    /* Color themes per emotion */
    .theme-happy   { --theme:#fde68a; }
    .theme-sad     { --theme:#bfdbfe; }
    .theme-angry   { --theme:#fecaca; }
    .theme-fear    { --theme:#ddd6fe; }
    .theme-calm    { --theme:#dbeafe; }
    .theme-shy     { --theme:#fde68a; }
    .theme-sleepy  { --theme:#e5e7eb; }
    .theme-fun     { --theme:#bbf7d0; }
    .panel.theme-happy  .panel-body{background:var(--theme)}
    .panel.theme-sad    .panel-body{background:var(--theme)}
    .panel.theme-angry  .panel-body{background:var(--theme)}
    .panel.theme-fear   .panel-body{background:var(--theme)}
    .panel.theme-calm   .panel-body{background:var(--theme)}
    .panel.theme-shy    .panel-body{background:var(--theme)}
    .panel.theme-sleepy .panel-body{background:var(--theme)}
    .panel.theme-fun    .panel-body{background:var(--theme)}

    /* Add emotion sheet */
    .sheet{width:min(560px,96vw);background:#fff;border-radius:20px;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .sheet .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    .sheet label{min-width:5.5em}
    .sheet input[type="text"]{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px}
    .sheet input[type="color"]{width:48px;height:40px;border:1px solid var(--border);border-radius:10px;background:#fff;padding:0}
    .sheet .emoji-preview{font-size:40px;line-height:1;padding:6px 10px;border:1px dashed var(--border);border-radius:10px;min-width:64px;text-align:center;background:#fff}
    .help{color:var(--muted);font-size:14px;margin-top:4px}

    /* Accessibility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header class="container" role="banner">
    <h1 id="title">ã©ã‚“ãªãã‚‚ã¡ï¼Ÿ</h1>
    <p id="desc">ãã‚‚ã¡ã‚’ãŠã—ãˆã¦ã€‚ãŠãŠããã²ã‚‡ã†ã˜ã—ã¦ã€ã‚ˆã¿ã‚ã’ã¾ã™ã€‚</p>
  </header>

  <main id="app" class="container" role="application" aria-describedby="desc">
    <section class="card" aria-label="ã›ã£ã¦ã„">
      <div class="controls" id="controls">
        <label class="switch" title="èª­ã¿ä¸Šã’ON/OFF">
          <input id="speechToggle" type="checkbox" checked aria-label="èª­ã¿ä¸Šã’ON/OFF" />
          <span>ğŸ”Š ã‚ˆã¿ã‚ã’</span>
        </label>
        <div class="range" title="ã‚ˆã¿ã‚ã’ã®ã€€ã¯ã‚„ã•">
          <span>ã¯ã‚„ã•</span>
          <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" aria-label="èª­ã¿ä¸Šã’ã®é€Ÿã•" />
          <output id="rateOut">1.0</output>
        </div>
        <button id="openAdd" class="add-btn primary" aria-haspopup="dialog" aria-controls="addOverlay">ï¼‹ ãã‚‚ã¡ã‚’è¿½åŠ </button>
      </div>
    </section>

    <section class="card" aria-label="ã‹ã‚“ã˜ã‚‡ã†ã‚’ãˆã‚‰ã¶">
      <div id="grid" class="grid" role="grid" aria-labelledby="title">
        <!-- Emotion buttons will be injected here -->
      </div>
    </section>
  </main>

  <!-- Big display dialog -->
  <div id="overlay" class="overlay" aria-hidden="true" aria-labelledby="chosen-label">
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <div class="panel-header">
        <h2 id="chosen-label" class="panel-title">ã„ã¾ã® ãã‚‚ã¡</h2>
        <button id="close" class="btn" aria-label="ã¨ã˜ã‚‹">âœ• ã¨ã˜ã‚‹</button>
      </div>
      <div class="panel-body">
        <div class="big">
          <div id="big-emoji" class="emoji" aria-hidden="true">ğŸ˜€</div>
          <div id="big-text" class="text" aria-live="polite">ã†ã‚Œã—ã„</div>
        </div>
      </div>
      <div class="panel-footer">
        <button id="say" class="btn primary">ğŸ”Š ã‚ˆã¿ã‚ã’</button>
        <button id="back" class="btn">â¬… ã‚‚ã©ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Add emotion dialog -->
  <div id="addOverlay" class="overlay" aria-hidden="true" aria-labelledby="addTitle">
    <div class="sheet" role="dialog" aria-modal="true" aria-describedby="addDesc">
      <div class="panel-header">
        <h2 id="addTitle" class="panel-title">ãã‚‚ã¡ã‚’ ã¤ã„ã‹</h2>
        <button id="addClose" class="btn" aria-label="ã¨ã˜ã‚‹">âœ• ã¨ã˜ã‚‹</button>
      </div>
      <div class="panel-body" style="display:block">
        <div class="row">
          <label for="addEmoji">ãˆã‚‚ã˜</label>
          <div class="emoji-preview" id="emojiPreview" aria-hidden="true">ğŸ™‚</div>
          <input id="addEmoji" type="text" inputmode="text" placeholder="ğŸ™‚ ãªã©" aria-label="çµµæ–‡å­—" maxlength="4" style="max-width:120px">
        </div>
        <div class="row">
          <label for="addLabel">ãªã¾ãˆ</label>
          <input id="addLabel" type="text" placeholder="ã†ãã†ã ãªã©" aria-label="ãªã¾ãˆ">
        </div>
        <div class="row">
          <label for="addColor">ã„ã‚</label>
          <input id="addColor" type="color" value="#e0f2fe" aria-label="èƒŒæ™¯ã„ã‚">
          <div class="help">â€» ãŠãŠããã²ã‚‡ã†ã˜ã—ãŸã¨ãã® ã†ã—ã‚ã® ã„ã‚</div>
        </div>
        <div class="help">ä¾‹ï¼šãˆã‚‚ã˜ã€ŒğŸ¤—ã€ ãªã¾ãˆã€Œã ã„ã™ãã€ ã„ã‚ã€Œã‚„ã•ã—ã„è‰²ã€</div>
      </div>
      <div class="panel-footer">
        <button id="addSave" class="btn primary">ğŸ’¾ ã»ãã‚“</button>
        <button id="addCancel" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <footer class="container" role="contentinfo">
    <p class="sr-only">Â© ç‰¹åˆ¥æ”¯æ´æ•™æé–‹ç™ºç ”ç©¶æ‰€</p>
  </footer>

  <script>
    // ---- Data -------------------------------------------------------------
    const DEFAULTS = [
      { key:'happy',  emoji:'ğŸ˜€', text:'ã†ã‚Œã—ã„' },
      { key:'sad',    emoji:'ğŸ˜¢', text:'ã‹ãªã—ã„' },
      { key:'angry',  emoji:'ğŸ˜¡', text:'ãŠã“ã£ã¦ã‚‹' },
      { key:'fear',   emoji:'ğŸ˜¨', text:'ã“ã‚ã„' },
      { key:'calm',   emoji:'ğŸ˜Œ', text:'ãŠã¡ã¤ã„ãŸ' },
      { key:'shy',    emoji:'ğŸ˜³', text:'ã¯ãšã‹ã—ã„' },
      { key:'sleepy', emoji:'ğŸ˜´', text:'ã­ã‚€ã„' },
      { key:'fun',    emoji:'ğŸ˜·', text:'ãŸã„ã¡ã‚‡ã†ãµã‚Šã‚‡ã†' },
    ];
    /* äº’æ›ç”¨ï¼šæ—§ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã® EMOTIONS å‚ç…§ã«ã‚‚å¯¾å¿œ */
    const EMOTIONS = DEFAULTS;

    const LS_KEY = 'customEmotions.v1';

    // ---- State ------------------------------------------------------------
    const state = { speechOn:true, rate:1.0, current:null, customs: loadCustoms() };

    // ---- DOM --------------------------------------------------------------
    const grid = document.getElementById('grid');
    const overlay = document.getElementById('overlay');
    const panel = document.getElementById('panel');
    const bigEmoji = document.getElementById('big-emoji');
    const bigText = document.getElementById('big-text');
    const speechToggle = document.getElementById('speechToggle');
    const rate = document.getElementById('rate');
    const rateOut = document.getElementById('rateOut');

    const openAdd = document.getElementById('openAdd');
    const addOverlay = document.getElementById('addOverlay');
    const addClose = document.getElementById('addClose');
    const addCancel = document.getElementById('addCancel');
    const addSave = document.getElementById('addSave');
    const addEmoji = document.getElementById('addEmoji');
    const addLabel = document.getElementById('addLabel');
    const addColor = document.getElementById('addColor');
    const emojiPreview = document.getElementById('emojiPreview');

    // ---- Utilities --------------------------------------------------------
    function loadCustoms(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch{ return []; }
    }
    function saveCustoms(){
      localStorage.setItem(LS_KEY, JSON.stringify(state.customs));
    }
    function allEmotions(){
      return [
        ...DEFAULTS,
        ...state.customs.map(c=>({ key:c.key, emoji:c.emoji, text:c.text, color:c.color }))
      ];
    }

    // Build buttons
    function renderGrid(){
      const items = allEmotions();
      grid.replaceChildren(...items.map((e)=>{
        const btn = document.createElement('button');
        btn.className = 'emobtn';
        btn.setAttribute('role','button');
        btn.setAttribute('aria-label', e.text);
        btn.dataset.key = e.key;
        btn.innerHTML = `<div class="emoji">${e.emoji}</div><div class="label">${e.text}</div>`;
        return btn;
      }));
    }

    // Open full-screen panel
    function openPanel(item){
      state.current = item;
      bigEmoji.textContent = item.emoji;
      bigText.textContent = item.text;

      // ãƒ†ãƒ¼ãƒèƒŒæ™¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ or ã‚«ã‚¹ã‚¿ãƒ è‰²ï¼‰
      panel.classList.remove(
        'theme-happy','theme-sad','theme-angry','theme-fear','theme-calm','theme-shy','theme-sleepy','theme-fun'
      );
      const body = panel.querySelector('.panel-body');
      body.style.background = '';
      if(item.color){
        body.style.background = item.color;
      }else{
        panel.classList.add('theme-' + item.key);
      }

      overlay.setAttribute('aria-hidden','false');
      if(state.speechOn) say(item.text);
      setTimeout(()=> document.getElementById('close').focus(), 50);
    }

    function closePanel(){
      overlay.setAttribute('aria-hidden','true');
      state.current = null;
    }

    // Speech synthesis
    function say(text){
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = 'ja-JP';
      uttr.rate = state.rate;
      const voices = speechSynthesis.getVoices();
      const jp = voices.find(v=> v.lang && v.lang.toLowerCase().startsWith('ja'));
      if(jp) uttr.voice = jp;
      speechSynthesis.speak(uttr);
    }

    // ---- Add dialog -------------------------------------------------------
    function openAddDialog(){
      addOverlay.setAttribute('aria-hidden','false');
      addEmoji.value = '';
      addLabel.value = '';
      emojiPreview.textContent = 'ğŸ™‚';
      addEmoji.focus();
    }
    function closeAddDialog(){
      addOverlay.setAttribute('aria-hidden','true');
    }
    function sanitizeLabel(s){
      return (s||'').trim().slice(0, 20);
    }
    function pickEmoji(s){
      const t = (s||'').trim();
      return t || 'ğŸ™‚';
    }
    function makeKey(){
      return 'c-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*1e4).toString(36);
    }

    // ---- Events -----------------------------------------------------------
    grid.addEventListener('click', (e)=>{
      const btn = e.target.closest('.emobtn');
      if(!btn) return;
      const item = allEmotions().find(x=> x.key === btn.dataset.key);
      if(item) openPanel(item);
    });

    document.getElementById('close').addEventListener('click', closePanel);
    document.getElementById('back').addEventListener('click', closePanel);
    document.getElementById('say').addEventListener('click', ()=>{
      if(state.current) say(state.current.text);
    });

    overlay.addEventListener('click', (e)=>{
      if(e.target === overlay) closePanel(); // click outside panel
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(addOverlay.getAttribute('aria-hidden') === 'false') closeAddDialog();
        else closePanel();
      }
      if(e.key === 'Enter' && state.current) say(state.current.text);
      if(e.key === 'ArrowLeft' || e.key === 'ArrowRight'){
        const items = allEmotions();
        const idx = items.findIndex(x=> x.key === (state.current?.key));
        if(idx >= 0){
          const next = e.key === 'ArrowRight' ? (idx+1)%items.length : (idx-1+items.length)%items.length;
          openPanel(items[next]);
        }
      }
    });

    speechToggle.addEventListener('change', ()=>{
      state.speechOn = speechToggle.checked;
    });
    rate.addEventListener('input', ()=>{
      state.rate = Number(rate.value);
      rateOut.textContent = state.rate.toFixed(1);
    });

    if('speechSynthesis' in window){
      window.speechSynthesis.onvoiceschanged = ()=>{};
    }

    // Add dialog events
    openAdd.addEventListener('click', openAddDialog);
    addClose.addEventListener('click', closeAddDialog);
    addCancel.addEventListener('click', closeAddDialog);
    addOverlay.addEventListener('click', (e)=>{
      if(e.target === addOverlay) closeAddDialog();
    });
    addEmoji.addEventListener('input', ()=>{
      emojiPreview.textContent = pickEmoji(addEmoji.value);
    });
    addSave.addEventListener('click', ()=>{
      const label = sanitizeLabel(addLabel.value);
      const emoji = pickEmoji(addEmoji.value);
      const color = addColor.value || '#e0f2fe';
      if(!label){
        addLabel.focus();
        addLabel.setAttribute('aria-invalid', 'true');
        return;
      }
      const entry = { key: makeKey(), emoji, text: label, color };
      state.customs.push(entry);
      saveCustoms();
      renderGrid();
      closeAddDialog();
      openPanel(entry);
    });

    // init
    renderGrid();
  </script>
</body>
</html>
